---
layout: post
title:  "[프로젝트] Medium 클론 백엔드를 만들어보자 -10"
tags: project
excerpt: "Medium 클론 백엔드를 설계부터 배포까지 기록하는 시리즈"
comments: true
---

**목차**
1. [Medium 클론 백엔드를 만들어보자 -1]({{site.baseurl}}/프로젝트-Medium-클론-백엔드를-만들어보자-1/)
2. [Medium 클론 백엔드를 만들어보자 -2]({{site.baseurl}}/프로젝트-Medium-클론-백엔드를-만들어보자-2/)
3. [Medium 클론 백엔드를 만들어보자 -3]({{site.baseurl}}/프로젝트-Medium-클론-백엔드를-만들어보자-3/)
4. [Medium 클론 백엔드를 만들어보자 -4]({{site.baseurl}}/프로젝트-Medium-클론-백엔드를-만들어보자-4/)
5. [Medium 클론 백엔드를 만들어보자 -5]({{site.baseurl}}/프로젝트-Medium-클론-백엔드를-만들어보자-5/)
6. [Medium 클론 백엔드를 만들어보자 -6]({{site.baseurl}}/프로젝트-Medium-클론-백엔드를-만들어보자-6/)
7. [Medium 클론 백엔드를 만들어보자 -7]({{site.baseurl}}/프로젝트-Medium-클론-백엔드를-만들어보자-7/)
8. [Medium 클론 백엔드를 만들어보자 -8]({{site.baseurl}}/프로젝트-Medium-클론-백엔드를-만들어보자-8/)
9. [Medium 클론 백엔드를 만들어보자 -9]({{site.baseurl}}/프로젝트-Medium-클론-백엔드를-만들어보자-9/)
10. Medium 클론 백엔드를 만들어보자 -10

# 이전 포스트에서 . . .
- AWS로 서버를 배포 해봄

# 이 포스트는 . . .
- 배포 과정을 자동화 시도

# Github Actions 환경 변수 문제 해결하기
자동화를 많이 해본 적은 없지만 현재까지 자동화를 하면서 가장 문제를 많이 일으켰던 부분은 환경변수를 설정하는 일이다.

현재 이 포스트를 작성하는 시점, 고 코드는 AWS RDS에 연결하는 기능까지 구현하고 난 직후다. AWS에 연결을 하려면 여러 환경변수를 사용해서 중요한 정보들을 관리한다. 동시에 Github에 push될 때 중요한 정보가 노출이 되지 않게 해야한다. 

여기서 말하는 중요한 정보란, 외부에 노출이 되었을 시 서버에 막대한 피해를 끼칠 수 있는 정보를 뜻한다. 예를 들면 관리자 비밀번호, 개인정보, 기타등등 있겠다.

현재 중요한 정보를 취급하는 방식은 다음과 같다.
1. `viper.yml` 파일에 중요한 정보를 저장한다
2. 고 서버 내에서는 `viper`라는 패키지를 써서 저장된 `viper.yml`파일에서 환경변수를 읽는다
3. `.gitignore`에 `viper.yml`을 작성하여 Github에 중요한 정보가 노출되지 않게 한다. 

이렇게 정보를 관리하게되면 기존에 만들어 놓았던 Github Actions의 Workflow가 실패한다. 정확히는 각 OS에서 서버를 실행 시킬 때 문제가 생긴다. 이유는 `viper.yml`이 Github에 없기 때문이다.

<img src="{{ site.baseurl}}/images/testfail.png" class="align-center" alt=""/>

이 문제를 해결하려면:
1. `viper.yml`파일을 Github에 올려서 Github Actions가 쓸 수 있게함
2. 코드를 수정해서 `viper.yml` 의존성을 없애고, 환경변수를 Github secret에 저장함
3. Dockerfile이나 `ci-docker-cd.yml` workflow 파일에서 환경 변수를 담은 `viper.yml` 파일을 생성함

여러가지 시행착오 끝에 현재 해결안을 살펴보면 다음과 같다.
1. `viper` 대신 `godotenv` 패키지를 활용해서 `viper.yml` 파일 의존성을 없앴다
2. 환경변수를 Github secrets로 저장시켰다
3. `ci-docker-cd.yml` (github workflow)에서 `secrets.XXX`로 저장된 값을 호출 한 후 필요한 곳에 사용했다
4. `Dockerfile` 도 `ARG` 로 `secrets.XXX`를 받은 뒤 `ENV`로 선언할 수 있도록 코드를 수정했다
5. 유닛 테스트에 환경변수가 제대로 로드되는지 확인하는 테스트를 작성했다

위 수정사항을 반영하는 시작점이 되는 [commit](https://github.com/json9512/mediumclone-backendwithgo/commit/8d14e0c57f47937d2ea0fd5113e5cc899961eb69)이다. 그리고 테스트 결과를 보면 Workflow가 다시 잘 작동하는 것을 볼 수 있다.

<img src="{{ site.baseurl}}/images/testsuccess.png" class="align-center" alt=""/>

어디까지나 위 수정사항은 CI/CD 파이프라인에서 코드만 테스트하는 것이다. 실제로 Docker 이미지가 생성된 후 컨테이너에서의 테스트는 하지 않았다. ~~지금은 하는 방법을 모른다~~

이 방식의 문제점은 다음과 같다:
1. 생성된 Docker 이미지가 컨테이너로 띄웠을 때 AWS RDS와 연결이 잘 되는지는 알 수 없음

# Docker 이미지 배포 방법 바꾸기
현재까지는 Docker Hub에 이미지를 자동배포를 했었다. 하지만 전 포스트에서 Docker Hub 대신에 AWS ECR로 이미지를 사용하는 법을 알았으니 CI/CD에서도 Docker Hub 말고 ECR로 자동 배포를 하려고 한다.

아마존 [블로그](https://aws.amazon.com/ko/blogs/containers/create-a-ci-cd-pipeline-for-amazon-ecs-with-github-actions-and-aws-codebuild-tests/) 글을 참고를 하니 이미 잘 설명이 돼있다.

AWS 개인 정보를 secrets에 저장 시킨 뒤 `ci-docker-cd.yml`에서 AWS ECR로 이미지를 배포하도록 수정을 하자. 

(추가 할 예정)
